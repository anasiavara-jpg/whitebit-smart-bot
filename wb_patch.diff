--- a/main.py
+++ b/main.py
@@
 def _normalize_market_cfg(cfg: dict) -> dict:
@@
     cfg.setdefault("hold_on_sl", False)    # —è–∫—â–æ True ‚Äî –ø—Ä–∏ SL –ù–ï –ø—Ä–æ–¥–∞—î–º–æ, –∞ —Ç—Ä–∏–º–∞—î–º–æ –º–æ–Ω–µ—Ç–∏
     cfg.setdefault("holdings_lock", False) # –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –ø—Ä–∞–ø–æ—Ä: –º–æ–Ω–µ—Ç–∏ ¬´–∑–∞–º–æ—Ä–æ–∂–µ–Ω—ñ¬ª –¥–æ –∞–ø-—Ç—Ä–µ–Ω–¥—É
+    # --- –∞–≤—Ç–æ-–≤–∏–ø–ª–∞—Ç–∞ —á–∞—Å—Ç–∏–Ω–∏ TP –Ω–∞ main
+    cfg.setdefault("auto_payout_enabled", True)
+    cfg.setdefault("auto_payout_pct", 30.0)
     return cfg
@@
 async def get_balance() -> dict:
     data = await private_post("/api/v4/trade-account/balance")
     logging.info(f"DEBUG balance: {data}")
     return data if isinstance(data, dict) else {}
 
+async def transfer_trade_to_main_usdt(amount_usdt: Decimal) -> dict:
+    """
+    –ü–µ—Ä–µ–∫–∞–∑ –∑ trade-–∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–∞ main —É USDT.
+    """
+    if amount_usdt <= 0:
+        return {"success": False, "message": "amount<=0"}
+    body = {"ticker": "USDT", "amount": str(amount_usdt), "from": "trade", "to": "main"}
+    return await private_post("/api/v4/main-account/transfer", body)
+
@@
     if cfg.get("tp"):
         tp_price = float(quantize_price(market, last_price * (1 + float(cfg["tp"]) / 100)))
         cfg["last_tp_price"] = tp_price
         cid = f"wb-{market}-tp-{ts}"
-        tp_order = await place_limit_order(market, "sell", tp_price, base_amount, client_order_id=cid)
-        oid = _extract_order_id(tp_order)
-        if oid:
-            cfg["orders"].append({"id": oid, "cid": cid, "type": "tp", "market": market})
+        tp_order = await place_limit_order(market, "sell", tp_price, base_amount, client_order_id=cid)
+        oid = _extract_order_id(tp_order)
+        if oid:
+            cfg["orders"].append({
+                "id": oid, "cid": cid, "type": "tp", "market": market,
+                "price": tp_price, "amount": float(base_amount)
+            })
 
     save_markets()
@@
     if can_place_tp:
         cid = f"wb-{market}-tp-{ts}"
         tp_order = await place_limit_order(market, "sell", tp_price, float(safe_amount), client_order_id=cid)
         oid = _extract_order_id(tp_order)
-        if oid:
-            cfg["orders"].append({"id": oid, "cid": cid, "type": "tp", "market": market})
+        if oid:
+            cfg["orders"].append({
+                "id": oid, "cid": cid, "type": "tp", "market": market,
+                "price": tp_price, "amount": float(safe_amount)
+            })
@@
 async def monitor_orders():
@@
-                                if want:
-                                    prof = cfg.get(f"profile_{want}") or {}
-                                    # –ø—ñ–¥–º—ñ–Ω–∞ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∑–Ω–∞—á–µ–Ω–Ω—è —î
-                                    for k in ("tp", "sl", "rebuy_pct", "scalp", "tick_pct", "levels"):
-                                        if k in prof:
-                                            cfg[k] = prof[k]
-                                    save_markets()
-                                                                    if want:
-                                    prof = cfg.get(f"profile_{want}") or {}
-                                    for k in ("tp", "sl", "rebuy_pct", "scalp", "tick_pct", "levels"):
-                                        if k in prof:
-                                            cfg[k] = prof[k]
-                                    save_markets()
+                                if want:
+                                    prof = cfg.get(f"profile_{want}") or {}
+                                    for k in ("tp", "sl", "rebuy_pct", "scalp", "tick_pct", "levels"):
+                                        if k in prof:
+                                            cfg[k] = prof[k]
+                                    save_markets()
 
                                     # üü¢ —è–∫—â–æ –º–æ–Ω–µ—Ç–∏ –±—É–ª–∏ ¬´–∑–∞–º–æ—Ä–æ–∂–µ–Ω—ñ¬ª –ø—ñ—Å–ª—è SL ‚Äî –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –Ω–∞ –∞–ø-—Ç—Ä–µ–Ω–¥—ñ
                                     if want == "up" and cfg.get("holdings_lock"):
                                         ok = await place_tp_sl_from_holdings(market, cfg)
                                         if ok and cfg.get("chat_id"):
                                             await bot.send_message(
                                                 cfg["chat_id"],
                                                 f"üü¢ {market}: –∞–ø-—Ç—Ä–µ–Ω–¥. –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ: –≤–∏—Å—Ç–∞–≤–ª–µ–Ω–æ TP –≤—ñ–¥ —Ö–æ–ª–¥–∏–Ω–≥—ñ–≤."
                                             )
                                         cfg["holdings_lock"] = False
                                         save_markets()
@@
-                        if mode == "trigger" and cfg.get("entry_price"):
+                        if mode == "trigger" and cfg.get("entry_price"):
                             threshold = float(cfg["entry_price"]) * (1 - sl_pct / 100)
                         elif mode == "trailing" and cfg.get("peak"):
                             threshold = float(cfg["peak"]) * (1 - sl_pct / 100)
 
-                                                if threshold and lp <= threshold:
+                        if threshold and lp <= threshold:
                             # —Å–∫–∞—Å–æ–≤—É—î–º–æ –≤—Å—ñ –ª—ñ–º—ñ—Ç–∏
                             acts = await active_orders(market)
                             for o in acts.get("orders", []):
                                 oid = o.get("orderId") or o.get("id")
                                 if oid:
                                     await cancel_order(market, order_id=str(oid))
 
                             cfg["orders"].clear()
                             save_markets()
 
-                            base_av = await get_base_available(market)
-
-                            if cfg.get("hold_on_sl"):
-                                # ‚úÖ –ú º—è–∫–∏–π SL: –ù–ï –ø—Ä–æ–¥–∞—î–º–æ —Ä–∏–Ω–∫–æ–º, ¬´–∑–∞–º–æ—Ä–æ–∂—É—î–º–æ¬ª —Ö–æ–ª–¥–∏–Ω–≥ –¥–æ –∞–ø-—Ç—Ä–µ–Ω–¥—É
-                                cfg["holdings_lock"] = True
-                                save_markets()
-                                if cfg.get("chat_id"):
-                                    await bot.send_message(
-                                        cfg["chat_id"],
-                                        f"üü° {market}: SL-—Ç—Ä–∏–≥–µ—Ä. –ú–æ–Ω–µ—Ç–∏ –∑–∞–ª–∏—à–µ–Ω–æ (hold_on_sl=ON). –ß–µ–∫–∞—é –∞–ø-—Ç—Ä–µ–Ω–¥—É."
-                                    )
-                            else:
-                                # –∑–≤–∏—á–∞–π–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞: –ø—Ä–æ–¥–∞—Ç–∏ —Ä–∏–Ω–∫–æ–º —É—Å–µ
-                                if base_av > 0:
-                                    await place_market_order(market, "sell", float(base_av))
-                                    if cfg.get("chat_id"):
-                                        await bot.send_message(cfg["chat_id"], f"üõë {market}: SL —Å–ø—Ä–∞—Ü—é–≤–∞–≤, –ø—Ä–æ–¥–∞–Ω–æ —Ä–∏–Ω–∫–æ–º.")
-
-                            # —Å–∫–∏–Ω—É—Ç–∏ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∏
-                            cfg["entry_price"] = None
-                            cfg["peak"] = None
-                            save_markets()
-                            continue  # –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –ø–∞—Ä–∏
-
-                            cfg["orders"].clear()
-                            save_markets()
-
-                            # –ø—Ä–æ–¥–∞—î–º–æ —Ä–∏–Ω–∫–æ–º —É—Å–µ, —â–æ —î –≤ BASE
-                            base_av = await get_base_available(market)
-                            if base_av > 0:
-                                await place_market_order(market, "sell", float(base_av))
-                                if cfg.get("chat_id"):
-                                    await bot.send_message(cfg["chat_id"], f"üõë {market}: SL —Å–ø—Ä–∞—Ü—é–≤–∞–≤, –ø—Ä–æ–¥–∞–Ω–æ —Ä–∏–Ω–∫–æ–º.")
-
-                            cfg["entry_price"] = None
-                            cfg["peak"] = None
-                            save_markets()
-                            continue  # –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–∏–Ω–∫—É
+                            base_av = await get_base_available(market)
+                            if cfg.get("hold_on_sl"):
+                                # ‚úÖ –ú º—è–∫–∏–π SL: –ù–ï –ø—Ä–æ–¥–∞—î–º–æ —Ä–∏–Ω–∫–æ–º, ¬´–∑–∞–º–æ—Ä–æ–∂—É—î–º–æ¬ª —Ö–æ–ª–¥–∏–Ω–≥ –¥–æ –∞–ø-—Ç—Ä–µ–Ω–¥—É
+                                cfg["holdings_lock"] = True
+                                save_markets()
+                                if cfg.get("chat_id"):
+                                    await bot.send_message(
+                                        cfg["chat_id"],
+                                        f"üü° {market}: SL-—Ç—Ä–∏–≥–µ—Ä. –ú–æ–Ω–µ—Ç–∏ –∑–∞–ª–∏—à–µ–Ω–æ (hold_on_sl=ON). –ß–µ–∫–∞—é –∞–ø-—Ç—Ä–µ–Ω–¥—É."
+                                    )
+                            else:
+                                # –∑–≤–∏—á–∞–π–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞: –ø—Ä–æ–¥–∞—Ç–∏ —Ä–∏–Ω–∫–æ–º —É—Å–µ
+                                if base_av > 0:
+                                    await place_market_order(market, "sell", float(base_av))
+                                    if cfg.get("chat_id"):
+                                        await bot.send_message(cfg["chat_id"], f"üõë {market}: SL —Å–ø—Ä–∞—Ü—é–≤–∞–≤, –ø—Ä–æ–¥–∞–Ω–æ —Ä–∏–Ω–∫–æ–º.")
+
+                            # —Å–∫–∏–Ω—É—Ç–∏ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∏
+                            cfg["entry_price"] = None
+                            cfg["peak"] = None
+                            save_markets()
+                            continue  # –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –ø–∞—Ä–∏
@@
                     if chat_id:
                         await bot.send_message(
                             chat_id=chat_id,
                             text=f"‚úÖ –û—Ä–¥–µ—Ä {finished_any['id']} ({market}, {finished_any['type']}) –∑–∞–∫—Ä–∏—Ç–æ!"
                         )
+
+                    # === AUTO-PAYOUT –ø—ñ—Å–ª—è TP ===
+                    try:
+                        if str(finished_any.get("type")) == "tp" and cfg.get("auto_payout_enabled"):
+                            tp_price = float(finished_any.get("price") or 0)
+                            tp_amount = float(finished_any.get("amount") or 0)
+                            if tp_price > 0 and tp_amount > 0:
+                                from decimal import ROUND_DOWN
+                                gross_usdt = Decimal(str(tp_price)) * Decimal(str(tp_amount))
+                                pct = Decimal(str(cfg.get("auto_payout_pct", 30.0)))
+                                pay = (gross_usdt * pct / Decimal("100")).quantize(Decimal("0.01"), rounding=ROUND_DOWN)
+                                pp = quote_step_from_rules(market)
+                                if pp > 0:
+                                    units = (pay / pp).to_integral_value(rounding=ROUND_DOWN)
+                                    pay = units * pp
+                                if pay > 0:
+                                    res = await transfer_trade_to_main_usdt(pay)
+                                    ok = isinstance(res, dict) and res.get("success") is not False
+                                    if ok and chat_id:
+                                        await bot.send_message(chat_id, f"üè¶ {market}: –∞–≤—Ç–æ-–≤–∏–≤—ñ–¥ {pay} USDT —É MAIN –≤–∏–∫–æ–Ω–∞–Ω–æ.")
+                                    elif not ok:
+                                        logging.warning(f"[PAYOUT] transfer failed: {res}")
+                    except Exception as e:
+                        logging.warning(f"[PAYOUT] error: {e}")
